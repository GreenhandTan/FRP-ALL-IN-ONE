version: '3.8'

services:
  # 1. æ ¸å¿ƒç®¡ç†åå° (Python API)
  backend:
    build: ../server
    container_name: frp-manager-backend
    restart: always
    user: root  # éœ€è¦ root æƒé™åˆ›å»ºæ–‡ä»¶å’Œå¯åŠ¨è¿›ç¨‹
    extra_hosts:
      - "host.docker.internal:host-gateway" # å…è®¸å®¹å™¨è®¿é—®å®¿ä¸»æœºç½‘ç»œ (ç”¨äºè¿æ¥ host æ¨¡å¼çš„ FRPS)
    volumes:
      - frp-data:/opt/frp       # FRP æ–‡ä»¶æŒä¹…åŒ–
      - ./frps.toml:/app/frps.toml  # FRPS é…ç½®æ–‡ä»¶ï¼ˆå¯è¯»å†™ï¼‰
      - /var/run/docker.sock:/var/run/docker.sock  # Docker Socketï¼ˆå…è®¸é‡å¯å®¹å™¨ï¼‰
    # æ³¨æ„ï¼šæ•°æ®åº“ä¸æŒä¹…åŒ–ï¼Œæ¯æ¬¡éƒ¨ç½²éƒ½æ˜¯å…¨æ–°å¼€å§‹

  # 2. Web ç•Œé¢ (Nginx + React)
  frontend:
    build: ../frontend
    container_name: frp-manager-web
    restart: always
    ports:
      - "80:80"  # å®¿ä¸»æœº80ç«¯å£ -> å®¹å™¨80ç«¯å£
    depends_on:
      - backend  # ä¸²è¡Œæ„å»ºï¼Œé¿å…å†…å­˜å åŠ 

  # 3. FRP Server (å®˜æ–¹é•œåƒ)
  frps:
    image: docker.1ms.run/snowdreamtech/frps:latest
    container_name: frps
    restart: always
    network_mode: "host" # ğŸ”¥ åªæœ‰ host æ¨¡å¼æ‰èƒ½é«˜æ€§èƒ½ä¸”æ— é™åˆ¶åœ°ä½¿ç”¨æ‰€æœ‰å®¿ä¸»æœºç«¯å£
    volumes:
      - ./frps.toml:/etc/frp/frps.toml
    # host æ¨¡å¼ä¸‹ ports æ˜ å°„æ— æ•ˆï¼Œæ‰€æœ‰ç«¯å£ç›´æ¥ç›‘å¬åœ¨å®¿ä¸»æœº

# å‘½åå·ï¼Œç¡®ä¿é‡å¯åæ•°æ®ä¸ä¸¢å¤±
volumes:
  frp-data:
